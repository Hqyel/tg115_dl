<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TG èµ„æºçˆ¬è™«ç®¡ç†</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div id="app">
    <!-- ç™»å½•é¡µé¢ -->
    <div v-if="!isLoggedIn" class="login-container">
      <div class="login-card">
        <div class="login-header">
          <h1>ğŸ¬ TG èµ„æºçˆ¬è™«</h1>
          <p>è¯·ç™»å½•ä»¥ç»§ç»­</p>
        </div>
        <form @submit.prevent="login" class="login-form">
          <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" v-model="loginForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" v-model="loginForm.password" placeholder="è¯·è¾“å…¥å¯†ç " required>
          </div>
          <button type="submit" class="btn btn-primary btn-block" :disabled="loading">
            {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
          </button>
          <p v-if="error" class="error-message">{{ error }}</p>
        </form>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div v-else class="main-container">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <div class="logo">
          <span class="logo-icon">ğŸ¬</span>
          <span class="logo-text">TG èµ„æºçˆ¬è™«</span>
        </div>
        <nav class="nav-menu">
          <a href="#" :class="{ active: currentPage === 'dashboard' }" @click.prevent="currentPage = 'dashboard'">
            <span class="nav-icon">ğŸ“Š</span> ä»ªè¡¨ç›˜
          </a>
          <a href="#" :class="{ active: currentPage === 'search' }" @click.prevent="currentPage = 'search'">
            <span class="nav-icon">ğŸ”</span> å½±è§†æœç´¢
          </a>
          <a href="#" :class="{ active: currentPage === 'resources' }" @click.prevent="currentPage = 'resources'">
            <span class="nav-icon">ğŸ“</span> æ•°æ®åº“
          </a>
          <a href="#" :class="{ active: currentPage === 'sync' }" @click.prevent="currentPage = 'sync'">
            <span class="nav-icon">âš™ï¸</span> åŒæ­¥ç®¡ç†
          </a>
        </nav>
        <div class="user-info">
          <span>ğŸ‘¤ {{ username }}</span>
          <button @click="logout" class="btn-logout">é€€å‡º</button>
        </div>
      </aside>

      <!-- ä¸»å†…å®¹åŒº -->
      <main class="main-content">
        <!-- ä»ªè¡¨ç›˜ -->
        <div v-if="currentPage === 'dashboard'" class="page">
          <h2 class="page-title">ğŸ“Š ä»ªè¡¨ç›˜</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">ğŸ“š</div>
              <div class="stat-info">
                <div class="stat-value">{{ dashboard.total_resources }}</div>
                <div class="stat-label">æ€»èµ„æºæ•°</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">âœ…</div>
              <div class="stat-info">
                <div class="stat-value">{{ dashboard.total_parsed }}</div>
                <div class="stat-label">å·²è§£æ</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸ“º</div>
              <div class="stat-info">
                <div class="stat-value">{{ dashboard.channels?.length || 0 }}</div>
                <div class="stat-label">é¢‘é“æ•°</div>
              </div>
            </div>
            <div class="stat-card" :class="{ running: dashboard.sync_status?.running }">
              <div class="stat-icon">{{ dashboard.sync_status?.running ? 'ğŸ”„' : 'â¸ï¸' }}</div>
              <div class="stat-info">
                <div class="stat-value">{{ dashboard.sync_status?.running ? 'è¿è¡Œä¸­' : 'ç©ºé—²' }}</div>
                <div class="stat-label">åŒæ­¥çŠ¶æ€</div>
              </div>
            </div>
          </div>

          <h3>é¢‘é“è¯¦æƒ…</h3>
          <div class="channels-grid">
            <div v-for="ch in dashboard.channels" :key="ch.id" class="channel-card">
              <div class="channel-header">
                <span class="channel-name">{{ ch.name }}</span>
                <span class="channel-mode">{{ ch.parse_mode }}</span>
              </div>
              <div class="channel-stats">
                <div class="channel-stat">
                  <span class="value">{{ ch.total }}</span>
                  <span class="label">æ€»æ•°</span>
                </div>
                <div class="channel-stat">
                  <span class="value">{{ ch.parsed }}</span>
                  <span class="label">å·²è§£æ</span>
                </div>
                <div class="channel-stat">
                  <span class="value">{{ ch.unparsed }}</span>
                  <span class="label">å¾…è§£æ</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœç´¢é¡µé¢ -->
        <div v-if="currentPage === 'search'" class="page">
          <h2 class="page-title">ğŸ” å½±è§†æœç´¢</h2>
          
          <div class="search-box">
            <input 
              type="text" 
              v-model="searchQuery" 
              placeholder="è¾“å…¥å…³é”®è¯æœç´¢..."
              @keyup.enter="doSearch"
              class="search-input"
            >
            <select v-model="searchChannel" class="search-select">
              <option value="">å…¨éƒ¨é¢‘é“</option>
              <option v-for="ch in channels" :key="ch.id" :value="ch.id">{{ ch.name }}</option>
            </select>
            <button @click="doSearch" class="btn btn-primary" :disabled="loading">
              {{ loading ? 'æœç´¢ä¸­...' : 'æœç´¢' }}
            </button>
          </div>

          <div v-if="searchResults.length > 0" class="search-results">
            <p class="results-count">æ‰¾åˆ° {{ searchResults.length }} æ¡ç»“æœ</p>
            <div class="results-grid">
              <div v-for="item in searchResults" :key="item.message_id" class="result-card">
                <div class="result-header">
                  <h3 class="result-title">{{ item.title }}</h3>
                  <span class="result-channel">{{ item.channel_name }}</span>
                </div>
                <div class="result-tags" v-if="item.tags">
                  <span v-for="tag in item.tags.split(',')" :key="tag" class="tag">{{ tag }}</span>
                </div>
                <div class="result-actions">
                  <button v-if="item.pan_url && item.pan_url !== 'N/A'" 
                          @click="copyLink(item.pan_url)" 
                          class="btn btn-success btn-sm">
                    ğŸ“‹ å¤åˆ¶é“¾æ¥
                  </button>
                  <a v-if="item.pan_url && item.pan_url !== 'N/A'" 
                     :href="item.pan_url" 
                     target="_blank" 
                     class="btn btn-outline btn-sm">
                    ğŸ”— æ‰“å¼€
                  </a>
                  <span v-if="!item.pan_url || item.pan_url === 'N/A'" class="no-link">æš‚æ— é“¾æ¥</span>
                </div>
              </div>
            </div>
          </div>
          <div v-else-if="searchPerformed" class="no-results">
            <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èµ„æº</p>
          </div>
        </div>

        <!-- æ•°æ®åº“é¡µé¢ -->
        <div v-if="currentPage === 'resources'" class="page">
          <h2 class="page-title">ğŸ“ æ•°æ®åº“æµè§ˆ</h2>
          
          <div class="filter-bar">
            <select v-model="resourceChannel" @change="loadResources" class="filter-select">
              <option v-for="ch in channels" :key="ch.id" :value="ch.id">{{ ch.name }}</option>
            </select>
            <span class="page-info">ç¬¬ {{ resourcePage }} é¡µ / å…± {{ resourceTotalPages }} é¡µ</span>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th>æ ‡é¢˜</th>
                <th>æ ‡ç­¾</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="item in resources" :key="item.message_id">
                <td class="title-cell">{{ item.title }}</td>
                <td class="tags-cell">{{ item.tags }}</td>
                <td><span :class="['status', item.pan_url && item.pan_url !== 'N/A' ? 'parsed' : 'unparsed']">
                  {{ item.pan_url && item.pan_url !== 'N/A' ? 'âœ…' : 'â³' }}
                </span></td>
                <td>
                  <button v-if="item.pan_url && item.pan_url !== 'N/A'" 
                          @click="copyLink(item.pan_url)" 
                          class="btn btn-sm">å¤åˆ¶</button>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="pagination">
            <button @click="resourcePage--; loadResources()" :disabled="resourcePage <= 1" class="btn btn-sm">ä¸Šä¸€é¡µ</button>
            <button @click="resourcePage++; loadResources()" :disabled="resourcePage >= resourceTotalPages" class="btn btn-sm">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>

        <!-- åŒæ­¥ç®¡ç†é¡µé¢ -->
        <div v-if="currentPage === 'sync'" class="page">
          <h2 class="page-title">âš™ï¸ åŒæ­¥ç®¡ç†</h2>
          
          <div class="sync-section">
            <h3>æ‰‹åŠ¨åŒæ­¥</h3>
            <div class="sync-controls">
              <select v-model="syncChannel" class="sync-select">
                <option value="all">å…¨éƒ¨é¢‘é“</option>
                <option v-for="ch in channels" :key="ch.id" :value="ch.id">{{ ch.name }}</option>
              </select>
              <button @click="syncNow('incremental')" class="btn btn-primary" :disabled="syncRunning">
                ğŸ”„ å¢é‡åŒæ­¥
              </button>
              <button @click="syncNow('full')" class="btn btn-warning" :disabled="syncRunning">
                ğŸ“¥ å…¨é‡åŒæ­¥
              </button>
            </div>
            <div v-if="syncStatus.message" class="sync-status" :class="{ running: syncStatus.running }">
              {{ syncStatus.message }}
            </div>
          </div>

          <div class="tasks-section">
            <h3>å®šæ—¶ä»»åŠ¡</h3>
            <div class="add-task-form">
              <select v-model="newTask.channel">
                <option value="all">å…¨éƒ¨é¢‘é“</option>
                <option v-for="ch in channels" :key="ch.id" :value="ch.id">{{ ch.name }}</option>
              </select>
              <select v-model="newTask.mode">
                <option value="incremental">å¢é‡åŒæ­¥</option>
                <option value="full">å…¨é‡åŒæ­¥</option>
              </select>
              <input type="number" v-model="newTask.interval" placeholder="é—´éš”(å°æ—¶)" min="1" max="168">
              <button @click="addTask" class="btn btn-primary">æ·»åŠ ä»»åŠ¡</button>
            </div>
            
            <table class="data-table" v-if="tasks.length > 0">
              <thead>
                <tr>
                  <th>ä»»åŠ¡åç§°</th>
                  <th>ä¸‹æ¬¡æ‰§è¡Œ</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="task in tasks" :key="task.id">
                  <td>{{ task.name }}</td>
                  <td>{{ formatDate(task.next_run) }}</td>
                  <td><button @click="deleteTask(task.id)" class="btn btn-danger btn-sm">åˆ é™¤</button></td>
                </tr>
              </tbody>
            </table>
            <p v-else class="no-tasks">æš‚æ— å®šæ—¶ä»»åŠ¡</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="/static/js/app.js"></script>
</body>
</html>
